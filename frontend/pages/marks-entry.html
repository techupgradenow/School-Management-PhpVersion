<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Fast Marks Entry</title>
	<link rel="stylesheet" href="../assets/css/style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="../assets/js/app.js"></script>
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f7fa; padding: 20px; }

		.page-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 20px;
			flex-wrap: wrap;
			gap: 16px;
		}
		.page-title h1 { font-size: 24px; font-weight: 700; color: #1e293b; }
		.page-title p { font-size: 14px; color: #64748b; margin-top: 4px; }

		.btn {
			padding: 12px 24px;
			border-radius: 10px;
			font-weight: 600;
			font-size: 14px;
			cursor: pointer;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			border: none;
			transition: all 0.2s;
		}
		.btn-primary { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
		.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4); }
		.btn-success { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
		.btn-success:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }
		.btn-outline { background: white; border: 2px solid #e2e8f0; color: #64748b; }
		.btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

		.controls-panel {
			background: white;
			border-radius: 16px;
			padding: 24px;
			margin-bottom: 20px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.05);
		}
		.controls-row {
			display: flex;
			gap: 16px;
			flex-wrap: wrap;
			align-items: flex-end;
		}
		.control-group {
			flex: 1;
			min-width: 180px;
		}
		.control-group label {
			display: block;
			font-size: 13px;
			font-weight: 600;
			color: #475569;
			margin-bottom: 8px;
		}
		.control-group select {
			width: 100%;
			height: 44px;
			padding: 0 16px;
			border: 2px solid #e2e8f0;
			border-radius: 10px;
			font-size: 14px;
			background: white;
			cursor: pointer;
		}
		.control-group select:focus { outline: none; border-color: #3b82f6; }

		.stats-row {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
			gap: 16px;
			margin-bottom: 20px;
		}
		.stat-card {
			background: white;
			border-radius: 12px;
			padding: 16px;
			text-align: center;
			box-shadow: 0 2px 8px rgba(0,0,0,0.05);
		}
		.stat-value { font-size: 28px; font-weight: 700; color: #1e293b; }
		.stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
		.stat-card.blue .stat-value { color: #3b82f6; }
		.stat-card.green .stat-value { color: #22c55e; }
		.stat-card.red .stat-value { color: #ef4444; }
		.stat-card.orange .stat-value { color: #f59e0b; }

		.marks-table-container {
			background: white;
			border-radius: 16px;
			padding: 24px;
			box-shadow: 0 2px 10px rgba(0,0,0,0.05);
		}
		.table-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
			flex-wrap: wrap;
			gap: 12px;
		}
		.table-title { font-size: 18px; font-weight: 600; color: #1e293b; }
		.table-actions { display: flex; gap: 12px; }

		.marks-table {
			width: 100%;
			border-collapse: collapse;
		}
		.marks-table th, .marks-table td {
			padding: 12px;
			text-align: left;
			border-bottom: 1px solid #e2e8f0;
		}
		.marks-table th {
			background: #f8fafc;
			font-weight: 600;
			color: #475569;
			font-size: 13px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			position: sticky;
			top: 0;
		}
		.marks-table tr:hover { background: #f8fafc; }

		.student-info {
			display: flex;
			align-items: center;
			gap: 12px;
		}
		.student-avatar {
			width: 36px;
			height: 36px;
			border-radius: 50%;
			background: linear-gradient(135deg, #3b82f6, #2563eb);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-weight: 600;
			font-size: 14px;
		}
		.student-avatar.female { background: linear-gradient(135deg, #ec4899, #db2777); }
		.student-name { font-weight: 500; color: #1e293b; }
		.student-roll { font-size: 12px; color: #64748b; }

		.marks-input {
			width: 80px;
			height: 40px;
			padding: 0 12px;
			border: 2px solid #e2e8f0;
			border-radius: 8px;
			font-size: 16px;
			font-weight: 600;
			text-align: center;
			transition: all 0.2s;
		}
		.marks-input:focus {
			outline: none;
			border-color: #3b82f6;
			box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
		}
		.marks-input.pass { border-color: #22c55e; background: #f0fdf4; }
		.marks-input.fail { border-color: #ef4444; background: #fef2f2; }
		.marks-input.invalid { border-color: #f59e0b; background: #fffbeb; }

		.result-badge {
			padding: 4px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
		}
		.result-badge.pass { background: #dcfce7; color: #16a34a; }
		.result-badge.fail { background: #fee2e2; color: #dc2626; }
		.result-badge.pending { background: #f3f4f6; color: #6b7280; }

		.percentage-bar {
			width: 100px;
			height: 8px;
			background: #e2e8f0;
			border-radius: 4px;
			overflow: hidden;
		}
		.percentage-fill {
			height: 100%;
			border-radius: 4px;
			transition: width 0.3s;
		}
		.percentage-fill.high { background: #22c55e; }
		.percentage-fill.medium { background: #f59e0b; }
		.percentage-fill.low { background: #ef4444; }

		.quick-actions {
			display: flex;
			gap: 8px;
		}
		.quick-btn {
			padding: 6px 12px;
			border: none;
			border-radius: 6px;
			font-size: 12px;
			cursor: pointer;
			transition: all 0.2s;
		}
		.quick-btn.absent { background: #fee2e2; color: #dc2626; }
		.quick-btn.full { background: #dcfce7; color: #16a34a; }

		.keyboard-hint {
			background: #f8fafc;
			border-radius: 8px;
			padding: 12px 16px;
			font-size: 13px;
			color: #64748b;
			margin-top: 16px;
		}
		.keyboard-hint kbd {
			background: white;
			padding: 2px 8px;
			border-radius: 4px;
			border: 1px solid #e2e8f0;
			font-family: monospace;
			margin: 0 4px;
		}

		.loading-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(255,255,255,0.9);
			display: none;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}
		.loading-overlay.show { display: flex; }
		.loading-spinner {
			width: 50px;
			height: 50px;
			border: 4px solid #e2e8f0;
			border-top-color: #3b82f6;
			border-radius: 50%;
			animation: spin 1s linear infinite;
		}
		@keyframes spin { to { transform: rotate(360deg); } }

		.toast {
			position: fixed;
			bottom: 20px;
			right: 20px;
			padding: 16px 24px;
			border-radius: 10px;
			color: white;
			font-weight: 500;
			transform: translateY(100px);
			opacity: 0;
			transition: all 0.3s;
			z-index: 1001;
		}
		.toast.show { transform: translateY(0); opacity: 1; }
		.toast.success { background: #22c55e; }
		.toast.error { background: #ef4444; }

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #64748b;
		}
		.empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
		.empty-state h3 { font-size: 18px; color: #1e293b; margin-bottom: 8px; }
	</style>
</head>
<body>
	<div class="loading-overlay" id="loadingOverlay">
		<div class="loading-spinner"></div>
	</div>

	<div class="toast" id="toast"></div>

	<div class="page-header">
		<div class="page-title">
			<h1><i class="fas fa-edit"></i> Fast Marks Entry</h1>
			<p>Quickly enter and manage student exam marks</p>
		</div>
		<div>
			<button class="btn btn-success" onclick="saveAllMarks()" id="saveBtn" disabled>
				<i class="fas fa-save"></i> Save All Marks
			</button>
		</div>
	</div>

	<div class="controls-panel">
		<div class="controls-row">
			<div class="control-group">
				<label><i class="fas fa-file-alt"></i> Select Exam</label>
				<select id="examSelect" onchange="loadExamData()">
					<option value="">-- Select Exam --</option>
				</select>
			</div>
			<div class="control-group">
				<label><i class="fas fa-filter"></i> Filter Section</label>
				<select id="sectionFilter" onchange="filterStudents()">
					<option value="">All Sections</option>
					<option value="A">Section A</option>
					<option value="B">Section B</option>
					<option value="C">Section C</option>
				</select>
			</div>
			<div class="control-group" style="flex: 0;">
				<label>&nbsp;</label>
				<button class="btn btn-outline" onclick="loadExams()">
					<i class="fas fa-sync"></i> Refresh
				</button>
			</div>
		</div>
	</div>

	<div class="stats-row" id="statsRow" style="display: none;">
		<div class="stat-card blue">
			<div class="stat-value" id="totalStudents">0</div>
			<div class="stat-label">Total Students</div>
		</div>
		<div class="stat-card green">
			<div class="stat-value" id="markedCount">0</div>
			<div class="stat-label">Marks Entered</div>
		</div>
		<div class="stat-card orange">
			<div class="stat-value" id="pendingCount">0</div>
			<div class="stat-label">Pending</div>
		</div>
		<div class="stat-card green">
			<div class="stat-value" id="passCount">0</div>
			<div class="stat-label">Passed</div>
		</div>
		<div class="stat-card red">
			<div class="stat-value" id="failCount">0</div>
			<div class="stat-label">Failed</div>
		</div>
		<div class="stat-card">
			<div class="stat-value" id="avgMarks">0</div>
			<div class="stat-label">Average</div>
		</div>
	</div>

	<div class="marks-table-container">
		<div class="table-header">
			<div class="table-title" id="tableTitle">Select an exam to enter marks</div>
			<div class="table-actions">
				<button class="btn btn-outline" onclick="markAllAbsent()" style="display:none;" id="absentBtn">
					<i class="fas fa-user-slash"></i> Mark Absent (0)
				</button>
			</div>
		</div>

		<div id="tableContainer">
			<div class="empty-state">
				<i class="fas fa-clipboard-list"></i>
				<h3>No Exam Selected</h3>
				<p>Please select an exam from the dropdown above to start entering marks</p>
			</div>
		</div>

		<div class="keyboard-hint" id="keyboardHint" style="display:none;">
			<i class="fas fa-keyboard"></i>
			<strong>Keyboard shortcuts:</strong>
			<kbd>Tab</kbd> / <kbd>Enter</kbd> Move to next |
			<kbd>Shift+Tab</kbd> Move to previous |
			<kbd>A</kbd> Mark Absent (0) |
			<kbd>F</kbd> Full Marks |
			<kbd>Ctrl+S</kbd> Save All
		</div>
	</div>

	<script>
		const API_BASE = '/School-Management-PhpVersion/backend/api';
		let currentExam = null;
		let studentsData = [];
		let marksData = {};
		let hasChanges = false;

		// Load exams on page load
		document.addEventListener('DOMContentLoaded', loadExams);

		// Keyboard shortcut for save
		document.addEventListener('keydown', function(e) {
			if (e.ctrlKey && e.key === 's') {
				e.preventDefault();
				if (!document.getElementById('saveBtn').disabled) {
					saveAllMarks();
				}
			}
		});

		function loadExams() {
			showLoading(true);
			$.ajax({
				url: API_BASE + '/exams.php',
				type: 'GET',
				success: function(response) {
					showLoading(false);
					if (response.success && response.data) {
						const exams = response.data;
						const select = document.getElementById('examSelect');
						select.innerHTML = '<option value="">-- Select Exam --</option>';
						exams.forEach(exam => {
							const option = document.createElement('option');
							option.value = exam.id;
							option.textContent = `${exam.name} - ${exam.class} (${exam.exam_date})`;
							option.dataset.exam = JSON.stringify(exam);
							select.appendChild(option);
						});
					}
				},
				error: function() {
					showLoading(false);
					showToast('Failed to load exams', 'error');
				}
			});
		}

		function loadExamData() {
			const examId = document.getElementById('examSelect').value;
			if (!examId) {
				document.getElementById('tableContainer').innerHTML = `
					<div class="empty-state">
						<i class="fas fa-clipboard-list"></i>
						<h3>No Exam Selected</h3>
						<p>Please select an exam from the dropdown above to start entering marks</p>
					</div>
				`;
				document.getElementById('statsRow').style.display = 'none';
				document.getElementById('keyboardHint').style.display = 'none';
				document.getElementById('absentBtn').style.display = 'none';
				document.getElementById('saveBtn').disabled = true;
				return;
			}

			showLoading(true);
			$.ajax({
				url: API_BASE + '/exam_marks.php?action=by_exam&exam_id=' + examId,
				type: 'GET',
				success: function(response) {
					showLoading(false);
					if (response.success && response.data) {
						currentExam = response.data.exam;
						studentsData = response.data.students;
						updateStats(response.data.stats);
						renderTable();
						document.getElementById('statsRow').style.display = 'grid';
						document.getElementById('keyboardHint').style.display = 'block';
						document.getElementById('absentBtn').style.display = 'inline-flex';
						document.getElementById('saveBtn').disabled = false;
						document.getElementById('tableTitle').textContent =
							`${currentExam.name} - Max: ${currentExam.max_marks}, Pass: ${currentExam.pass_marks}`;
					}
				},
				error: function() {
					showLoading(false);
					showToast('Failed to load exam data', 'error');
				}
			});
		}

		function updateStats(stats) {
			document.getElementById('totalStudents').textContent = stats.total_students;
			document.getElementById('markedCount').textContent = stats.marked;
			document.getElementById('pendingCount').textContent = stats.pending;
			document.getElementById('passCount').textContent = stats.passed;
			document.getElementById('failCount').textContent = stats.failed;
			document.getElementById('avgMarks').textContent = stats.average;
		}

		function renderTable() {
			const section = document.getElementById('sectionFilter').value;
			let filtered = studentsData;

			if (section) {
				filtered = studentsData.filter(s => s.section === section);
			}

			if (filtered.length === 0) {
				document.getElementById('tableContainer').innerHTML = `
					<div class="empty-state">
						<i class="fas fa-users"></i>
						<h3>No Students Found</h3>
						<p>No students found for the selected criteria</p>
					</div>
				`;
				return;
			}

			let html = `
				<table class="marks-table">
					<thead>
						<tr>
							<th style="width:50px;">#</th>
							<th>Student</th>
							<th style="width:80px;">Section</th>
							<th style="width:120px;">Marks (/${currentExam.max_marks})</th>
							<th style="width:100px;">%</th>
							<th style="width:80px;">Result</th>
							<th style="width:120px;">Quick</th>
						</tr>
					</thead>
					<tbody>
			`;

			filtered.forEach((student, idx) => {
				const marks = student.marks_obtained;
				const hasMarks = marks !== null && marks !== undefined;
				const percentage = hasMarks ? Math.round((marks / currentExam.max_marks) * 100) : 0;
				const passed = hasMarks && marks >= currentExam.pass_marks;
				const initials = student.name.split(' ').map(n => n[0]).join('').substring(0, 2);
				const avatarClass = student.gender === 'Female' ? 'female' : '';

				let inputClass = '';
				if (hasMarks) {
					inputClass = passed ? 'pass' : 'fail';
				}

				let resultBadge = '<span class="result-badge pending">-</span>';
				if (hasMarks) {
					resultBadge = passed
						? '<span class="result-badge pass">Pass</span>'
						: '<span class="result-badge fail">Fail</span>';
				}

				let percentageClass = 'low';
				if (percentage >= 75) percentageClass = 'high';
				else if (percentage >= 40) percentageClass = 'medium';

				html += `
					<tr data-student-id="${student.id}">
						<td>${idx + 1}</td>
						<td>
							<div class="student-info">
								<div class="student-avatar ${avatarClass}">${initials}</div>
								<div>
									<div class="student-name">${student.name}</div>
									<div class="student-roll">Roll: ${student.roll_no || '-'}</div>
								</div>
							</div>
						</td>
						<td>${student.section}</td>
						<td>
							<input type="number"
								class="marks-input ${inputClass}"
								id="marks_${student.id}"
								value="${hasMarks ? marks : ''}"
								min="0"
								max="${currentExam.max_marks}"
								placeholder="--"
								onchange="onMarksChange('${student.id}')"
								onkeydown="onMarksKeydown(event, '${student.id}')"
								data-idx="${idx}">
						</td>
						<td>
							<div style="display:flex;align-items:center;gap:8px;">
								<span id="percent_${student.id}">${hasMarks ? percentage + '%' : '-'}</span>
								<div class="percentage-bar">
									<div class="percentage-fill ${percentageClass}" id="bar_${student.id}" style="width:${percentage}%"></div>
								</div>
							</div>
						</td>
						<td id="result_${student.id}">${resultBadge}</td>
						<td>
							<div class="quick-actions">
								<button class="quick-btn absent" onclick="setMarks('${student.id}', 0)" title="Absent">AB</button>
								<button class="quick-btn full" onclick="setMarks('${student.id}', ${currentExam.max_marks})" title="Full Marks">FM</button>
							</div>
						</td>
					</tr>
				`;
			});

			html += '</tbody></table>';
			document.getElementById('tableContainer').innerHTML = html;

			// Focus first empty input
			const firstEmpty = document.querySelector('.marks-input:not([value]), .marks-input[value=""]');
			if (firstEmpty) firstEmpty.focus();
		}

		function filterStudents() {
			renderTable();
		}

		function onMarksChange(studentId) {
			const input = document.getElementById('marks_' + studentId);
			let value = parseFloat(input.value);

			// Validate
			if (isNaN(value) || value < 0) {
				input.classList.add('invalid');
				input.classList.remove('pass', 'fail');
				return;
			}

			if (value > currentExam.max_marks) {
				value = currentExam.max_marks;
				input.value = value;
			}

			input.classList.remove('invalid');

			// Update UI
			const percentage = Math.round((value / currentExam.max_marks) * 100);
			const passed = value >= currentExam.pass_marks;

			input.classList.toggle('pass', passed);
			input.classList.toggle('fail', !passed);

			document.getElementById('percent_' + studentId).textContent = percentage + '%';

			const bar = document.getElementById('bar_' + studentId);
			bar.style.width = percentage + '%';
			bar.className = 'percentage-fill ' + (percentage >= 75 ? 'high' : percentage >= 40 ? 'medium' : 'low');

			document.getElementById('result_' + studentId).innerHTML = passed
				? '<span class="result-badge pass">Pass</span>'
				: '<span class="result-badge fail">Fail</span>';

			// Track changes
			marksData[studentId] = value;
			hasChanges = true;
			updateLocalStats();
		}

		function onMarksKeydown(e, studentId) {
			const input = e.target;
			const idx = parseInt(input.dataset.idx);

			if (e.key === 'Enter' || (e.key === 'Tab' && !e.shiftKey)) {
				e.preventDefault();
				const nextInput = document.querySelector(`[data-idx="${idx + 1}"]`);
				if (nextInput) nextInput.focus();
			} else if (e.key === 'Tab' && e.shiftKey) {
				e.preventDefault();
				const prevInput = document.querySelector(`[data-idx="${idx - 1}"]`);
				if (prevInput) prevInput.focus();
			} else if (e.key.toLowerCase() === 'a') {
				e.preventDefault();
				setMarks(studentId, 0);
			} else if (e.key.toLowerCase() === 'f') {
				e.preventDefault();
				setMarks(studentId, currentExam.max_marks);
			}
		}

		function setMarks(studentId, value) {
			const input = document.getElementById('marks_' + studentId);
			input.value = value;
			onMarksChange(studentId);

			// Move to next
			const idx = parseInt(input.dataset.idx);
			const nextInput = document.querySelector(`[data-idx="${idx + 1}"]`);
			if (nextInput) nextInput.focus();
		}

		function markAllAbsent() {
			if (!confirm('Mark all remaining students as Absent (0 marks)?')) return;

			document.querySelectorAll('.marks-input').forEach(input => {
				if (!input.value) {
					const studentId = input.id.replace('marks_', '');
					setMarks(studentId, 0);
				}
			});
		}

		function updateLocalStats() {
			let marked = 0, passed = 0, total = 0;

			document.querySelectorAll('.marks-input').forEach(input => {
				if (input.value !== '') {
					marked++;
					total += parseFloat(input.value);
					if (parseFloat(input.value) >= currentExam.pass_marks) passed++;
				}
			});

			const totalStudents = studentsData.length;
			document.getElementById('markedCount').textContent = marked;
			document.getElementById('pendingCount').textContent = totalStudents - marked;
			document.getElementById('passCount').textContent = passed;
			document.getElementById('failCount').textContent = marked - passed;
			document.getElementById('avgMarks').textContent = marked > 0 ? Math.round(total / marked) : 0;
		}

		function saveAllMarks() {
			const marks = [];

			document.querySelectorAll('.marks-input').forEach(input => {
				if (input.value !== '') {
					const studentId = input.id.replace('marks_', '');
					marks.push({
						student_id: studentId,
						marks_obtained: parseFloat(input.value)
					});
				}
			});

			if (marks.length === 0) {
				showToast('No marks to save', 'error');
				return;
			}

			showLoading(true);
			$.ajax({
				url: API_BASE + '/exam_marks.php',
				type: 'POST',
				contentType: 'application/json',
				data: JSON.stringify({
					action: 'bulk',
					exam_id: currentExam.id,
					marks: marks
				}),
				success: function(response) {
					showLoading(false);
					if (response.success) {
						showToast(`Saved ${response.data.saved} marks successfully!`, 'success');
						hasChanges = false;
						loadExamData(); // Reload to get fresh stats
					} else {
						showToast(response.message || 'Failed to save', 'error');
					}
				},
				error: function() {
					showLoading(false);
					showToast('Failed to save marks', 'error');
				}
			});
		}

		function showLoading(show) {
			document.getElementById('loadingOverlay').classList.toggle('show', show);
		}

		function showToast(message, type) {
			const toast = document.getElementById('toast');
			toast.textContent = message;
			toast.className = 'toast ' + type + ' show';
			setTimeout(() => toast.classList.remove('show'), 3000);
		}

		// Warn before leaving with unsaved changes
		window.onbeforeunload = function() {
			if (hasChanges) return 'You have unsaved changes!';
		};
	</script>
</body>
</html>
